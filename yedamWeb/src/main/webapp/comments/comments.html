<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		textarea {
			resize: none;
		}

		#commentUpdate {
			display: none;
		}
	</style>
	<script>
		window.onload = function () {
			loadCommentList();
		}

		// 목록조회
		function loadCommentList() {
			// ajax 호출, servlet 호출
			let xhtp = new XMLHttpRequest();
			xhtp.open("get", "../CommentsServ?cmd=selectAll");
			xhtp.send();
			xhtp.onreadystatechange = loadCommentResult;
		}

		// 조회결과
		function loadCommentResult() {
			if (this.readyState == 4 && this.status == 200) {
				let xmp = new DOMParser();
				let xmlDoc = xmp.parseFromString(this.responseText, 'text/xml');
				let code = xmlDoc.getElementsByTagName('code')[0].innerHTML;
				let listDiv = document.getElementById('commentList');
				if (code == 'success') {
					let commentList = eval(xmlDoc.getElementsByTagName('data')[0].innerHTML);
					console.log(commentList);
					for (let i = 0; i < commentList.length; i++) {
						listDiv.appendChild(makeCommentView(commentList[i]));
					}
				}
			}
		}

		// 한 건을 조회
		function makeCommentView(comment) {
			let div = document.createElement('div');
			div.setAttribute('id', comment.id);
			div.className = 'comment';
			div.comment = comment;

			let str = '<strong>' + comment.name + '</strong>';
			str += comment.content;
			str += '<input type="button" value="수정" onclick="viewUpdateForm(';
			str += comment.id + ')">';
			str += '<input type="button" value="삭제" onclick="confirmDeletion(';
			str += comment.id + ')">';

			div.innerHTML = str;
			return div;
		}

		function addComment() {
			let name = addForm.name.value;
			if (name == "") {
				alert('please...');
				addForm.name.focus();
				return;
			}
			let content = addForm.content.value;
			if (content == "") {
				alert('please...');
				addForm.content.focus();
				return;
			}
			let param = "&name=" + name + "&content=" + content;
			console.log(param);
			let xhtp = new XMLHttpRequest();
			xhtp.open("get", "../CommentsServ?cmd=insert" + param);
			xhtp.send();
			xhtp.onreadystatechange = addResult;
		}

		// 등록 콜백 함수
		function addResult() {
			if (this.readyState == 4 && this.status == 200) {
				let xmp = new DOMParser();
				let xmlDoc = xmp.parseFromString(this.responseText, 'text/xml');
				let code = xmlDoc.getElementsByTagName('code')[0].innerHTML;
				let listDiv = document.getElementById('commentList');
				if (code = 'success') {
					let comment = JSON.parse(xmlDoc.getElementsByTagName('data').item(0).innerHTML);
					console.log(comment);
					listDiv.appendChild(makeCommentView(comment));
					addForm.name.value="";
					addForm.content.value="";
				} else if (code = 'error') {
					alert("error");
				}
			}
		}

		// 수정
		function viewUpdateForm(commentId){
			let commentDiv = document.getElementById(commentId);
			let updateFormDiv = document.getElementById('commentUpdate');
			updateFormDiv.style.display = "block";

			commentDiv.appendChild(updateFormDiv);
			let comment = commentDiv.comment;
			console.log(updateForm.id);
			updateForm.id.value = comment.id;
			updateForm.name.value = comment.name;
			updateForm.content.value = comment.content;
		}

		// 변경 버튼
		function updateComment(){
			
		}
	</script>
	<title>To-do Lists</title>
</head>

<body>
	<div id="commentList"></div>
	<!-- 글등록 -->
	<div id="commentAdd">
		<form action="" name="addForm">
			<div>이름 : <input type="text" name="name" size="10"></div>
			<div>내용 : <textarea type="content" name="content" cols="20" rows="2"></textarea></div>
			<input type="button" value="등록" onclick="addComment()">
		</form>
	</div>
	<!-- 글수정 -->
	<div id="commentUpdate">
		<form action="" name="updateForm">
			<input type="hidden" name="id" value="">
			<div>이름 : <input type="text" name="name" size="10"></div>
			<div>내용 : <textarea type="content" name="content" cols="20" rows="2"></textarea></div>
			<input type="button" value="변경" onclick="updateComment()">
			<input type="button" value="취소" onclick="cancelComment()">
		</form>
	</div>
</body>

</html>